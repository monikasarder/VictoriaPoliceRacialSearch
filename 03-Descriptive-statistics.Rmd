---
title: "Summary statistics search data"
author: "Monika Sarder"
date: "2024-09-16"
output: html_document
---

```{r setup, echo = FALSE, warning = FALSE, message=FALSE}
knitr::opts_chunk$set(results = "asis")

library(tidyverse)
library(plotly)
library(summarytools)
library(kableExtra)
library(magrittr)
library(rmarkdown)
library(forcats)
library(gmodels)
library(crosstable)
library(janitor)
library(DT)
library(plotly)
```



```{r wrangle data, echo=FALSE, warning=FALSE, message = FALSE}
bdat <- readRDS("Output.data/Uniform.searches.with.hierarchy.RDS")

bdat <- bdat %>%
  filter(Unit.type == "Uniform",
         Contact.Type == "P",
         !is.na(Local.Government.Area))

bdat <- bdat %>%
  mutate(Racialised = ifelse(Racial.appearance == "White", "White", "Non-white"),
         `Found item` = ifelse(Found == 1, "Yes", "No"))

dat <- bdat %>%
  filter(!is.na(Racial.appearance))
```

## Data overview

The below dataset describes `r nrow(dat)` searches carried out by uniformed police relating to persons (not vehicles) without warrant in 2022 and 2023, excluding searches on person for whom a Firearm Prohibition Order was in effect.  

A total of `r nrow(bdat) - nrow(dat)` were removed due to police failing to record no racial appearance data being entered onto the form, despite this being a mandatory requirement.

```{r Table all, echo=FALSE, warning=FALSE, message = FALSE}

dat %>%
  tabyl(`Found item`, Racial.appearance) %>%
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("col") %>% 
  adorn_pct_formatting(rounding = "half up", digits = 1) %>%
  adorn_ns() %>%
  adorn_title("combined") %>%
  as.data.frame()%>%
  rename(Found = `Found item/Racial.appearance`)%>%
  mutate(Found = case_when(
    Found == "Yes" ~ "Hit rate",
    Found == "No" ~ "Nothing found",
    TRUE ~ Found))%>%
  mutate(Found = factor(Found, levels = c("Hit rate", "Nothing found", "Total")))%>%
  arrange(Found)%>%
  knitr::kable()
  
```  
  
```{r Plot all, echo=FALSE, warning=FALSE, message = FALSE}

dat %>%
  group_by(Racial.appearance)%>%
  mutate(Total = n(), Finds = sum(Found == 1, na.rm = T))%>%
  ungroup()%>%
  group_by(Racial.appearance, `Found item` , Total, Finds)%>%
  summarise(n = n())%>%
  plot_ly(x = ~ Racial.appearance,
          y = ~ n,
          color = ~ `Found item` ,
          text = ~paste("Racial appearance=", Racial.appearance, 
                        "<br>", "Searches=", Total,
                        "<br>", "Finds=", Finds),
          hoverinfo = "text")%>%
 layout(title = "Searches by racial appearance and find proportion 2022 and 2023",
        xaxis = list(title = "Racial appearance"),
        yaxis = list (title = "No. of searches"))
```

```{r Area type hit rate, echo=FALSE, warning=FALSE, message = FALSE}

lga.racial.hit <- dat %>%
  group_by(Area.type)%>%
  mutate(`Total searches` = n(),`Hit rate all` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  ungroup()%>%
  group_by(Area.type, Racialised, `Total searches` ,`Hit rate all`)%>%
  summarise(`Hit rate` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  pivot_wider(names_from = Racialised,
    values_from = c(`Hit rate`)
  )%>%
  mutate(Disproportionality = round(White/`Non-white`, digits = 2))%>%
  select( `Area type` = Area.type, `Total searches`, `Non-white hit rate` = `Non-white`, `White hit rate` = White, `All hit rate` = `Hit rate all`, Disproportionality)%>%
  arrange(desc(Disproportionality))

datatable(lga.racial.hit, rownames = FALSE)
```


# Hit rates by Police Region


```{r region poc, echo=FALSE, warning=FALSE, message = FALSE}

lga.racial.hit <- dat %>%
  group_by(Region)%>%
  mutate(`Total searches` = n(),`Hit rate all` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  ungroup()%>%
  group_by( Region,  Racialised, `Total searches` ,`Hit rate all`)%>%
  summarise(`Hit rate` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  pivot_wider(names_from = Racialised,
    values_from = c(`Hit rate`)
  )%>%
  mutate(Disproportionality = round(White/`Non-white`, digits = 2))%>%
  select(Region,  `Total searches`, `Non-white hit rate` = `Non-white`, `White hit rate` = White, `All hit rate` = `Hit rate all`, Disproportionality)%>%
  arrange(desc(Disproportionality))

datatable(lga.racial.hit, rownames = FALSE)
```

# Hit rates by Police Region


```{r region racial, echo=FALSE, warning=FALSE, message = FALSE}

lga.racial.hit <- dat %>%
  group_by(Region)%>%
  mutate(`Total searches` = n(),`Hit rate all` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  ungroup()%>%
  group_by( Region,  Racial.appearance, `Total searches` ,`Hit rate all`)%>%
  summarise(`Hit rate` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  pivot_wider(names_from = Racial.appearance,
    values_from = c(`Hit rate`)
  )#%>%
  #mutate(Disproportionality = round(White/`Non-white`, digits = 2))%>%
 # select(Region,  `Total searches`, `Non-white hit rate` = `Non-white`, `White hit rate` = White, `All hit rate` = `Hit rate all`, Disproportionality)%>%
#  arrange(desc(Disproportionality))

datatable(lga.racial.hit, rownames = FALSE)
```

## Hit rates by Police Service Area: Melbourne


```{r LGA hit rate metro, echo=FALSE, warning=FALSE, message = FALSE}

lga.racial.hit <- dat %>%
  filter(`Area.type` == "Metro")%>%
  group_by(Police.Service.Area, Region)%>%
  mutate(`Total searches` = n(),`Hit rate all` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  ungroup()%>%
  group_by( Region, Police.Service.Area, Racialised, `Total searches` ,`Hit rate all`)%>%
  summarise(`Hit rate` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  pivot_wider(names_from = Racialised,
    values_from = c(`Hit rate`)
  )%>%
  mutate(Disproportionality = round(White/`Non-white`, digits = 2))%>%
  select(Region, `Police Service Area` = Police.Service.Area, `Total searches`, `Non-white hit rate` = `Non-white`, `White hit rate` = White, `All hit rate` = `Hit rate all`, Disproportionality)%>%
  arrange(desc(Disproportionality))

datatable(lga.racial.hit, rownames = FALSE)
```

## Hit rates by Police Service Area: Region


```{r LGA hit rate, echo=FALSE, warning=FALSE, message = FALSE}

lga.racial.hit <- dat %>%
  filter(`Area.type` != "Metro")%>%
  group_by(Police.Service.Area, Region)%>%
  mutate(`Total searches` = n(),`Hit rate all` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  ungroup()%>%
  group_by( Region, Police.Service.Area, Racialised, `Total searches` ,`Hit rate all`)%>%
  summarise(`Hit rate` = round(sum(Found == 1, na.rm = T)/n()*100, digits =1))%>%
  pivot_wider(names_from = Racialised,
    values_from = c(`Hit rate`)
  )%>%
  mutate(Disproportionality = round(White/`Non-white`, digits = 2))%>%
  select(Region, `Police Service Area` = Police.Service.Area, `Total searches`, `Non-white hit rate` = `Non-white`, `White hit rate` = White, `All hit rate` = `Hit rate all`, Disproportionality)%>%
  arrange(desc(Disproportionality))

datatable(lga.racial.hit, rownames = FALSE)
```